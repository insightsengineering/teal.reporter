---
title: "Reporter Previewer"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reporter Previewer}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```r
library(shiny)
library(teal.reporter)
library(ggplot2)
library(rtables)
```

```r
ui <- fluidPage(
  titlePanel(""),
  tabsetPanel(
    tabPanel(
      "main App",
      tags$br(),
      tags$br(),
      sidebarLayout(
        uiOutput("encoding"),
        mainPanel(
          ### REPORTER
          teal.reporter::add_card_button_ui("addReportCard"),
          teal.reporter::download_report_button_ui("downloadButton"),
          teal.reporter::reset_report_button_ui("resetButton"),
          ###
          tags$br(),
          tags$br(),
          tabsetPanel(
            id = "tabs",
            tabPanel("Plot", plotOutput("dist_plot")),
            tabPanel("Table", verbatimTextOutput("table")),
            tabPanel("Table2", verbatimTextOutput("table2"))
          )
        )
      )
    ),
    tabPanel(
      "Previewer",
      reporter_previewer_ui("prev")
    )
  )
)

server <- function(input, output, session) {
  output$encoding <- renderUI({
    if (input$tabs == "Plot") {
      sidebarPanel(
        sliderInput(
          "binwidth",
          "binwidth",
          min = 2,
          max = 10,
          value = 8
        )
      )
    } else if (input$tabs %in% c("Table", "Table2")) {
      sidebarPanel(
        selectInput(
          "stat",
          label = "Statistic",
          choices = c("mean", "median", "sd"),
          "mean"
        )
      )
    } else {
      NULL
    }
  })
  
  plot <- reactive({
    req(input$binwidth)
    x <- mtcars$mpg
    ggplot2::ggplot(data = mtcars, ggplot2::aes(x = mpg)) +
      ggplot2::geom_histogram(binwidth = input$binwidth)
  })
  
  output$dist_plot <- renderPlot({
    plot()
  })
  
  table <- reactive({
    req(input$stat)
    lyt <- basic_table() %>%
        split_rows_by("Month", label_pos = "visible") %>%
        analyze("Ozone", afun = eval(str2expression(input$stat)))
    build_table(lyt, airquality)
  })
  
  output$table <- renderPrint({
    table()
  })
  
  table2 <- reactive({
    req(input$stat)
    aggregate(airquality[, c("Ozone"), drop = FALSE], list(Month = airquality$Month), get(input$stat), na.rm = TRUE)
  })
  
  output$table2 <- renderPrint({
    print.data.frame(table2())
  })
  
  ### REPORTER
  reporter <- teal.reporter::Reporter$new()
  card_fun <- function(card = ReportCard$new(), comment) {
    if (input$tabs == "Plot") {
      card$set_name("Plot Module")
      card$append_text("My plot", "header2")
      card$append_plot(plot())
      card$append_text(sprintf("x <- mtcars$mpg 
      ggplot2::ggplot(data = mtcars, ggplot2::aes(x = mpg)) + 
      ggplot2::geom_histogram(binwidth = %s)", input$binwidth), "verbatim")
    } else if (input$tabs == "Table") {
      card$set_name("Table Module")
      card$append_text("My Table", "header2")
      card$append_table(table())
      card$append_text(sprintf('lyt <- basic_table() %%>%% 
        split_rows_by("Month", label_pos = "visible") %%>%% 
        analyze("Ozone", afun = %s) 
    build_table(lyt, airquality)', input$stat), "verbatim")
    } else if (input$tabs == "Table2") {
      card$set_name("Table Module 2")
      card$append_text("My Table 2", "header2")
      card$append_table(table2())
      card$append_text(sprintf('aggregate(airquality[, c("Ozone"), drop = FALSE], list(Month = airquality$Month), 
      %s, 
      na.rm = TRUE)', input$stat), "verbatim")
    }
    card$append_text("Comment", "header3")
    card$append_text(comment)
    card
  }
  
  teal.reporter::add_card_button_srv("addReportCard", reporter = reporter, card_fun = card_fun)
  teal.reporter::download_report_button_srv("downloadButton", reporter = reporter)
  teal.reporter::reset_report_button_srv("resetButton", reporter)
  teal.reporter::reporter_previewer_srv("prev", reporter)
  ###
}

shinyApp(ui = ui, server = server)
```
